<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HSK4級 ピンインクイズ（クリック式）</title>
<style>
:root{
--bg:#ffffff; --card:#f8f9fa; --text:#000000; --muted:#555555; --accent:#2b4bc9; --ok:#0a7d42; --ng:#c62828;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Helvetica,Arial,"Noto Sans JP",sans-serif;}
.wrap{max-width:840px;margin:24px auto;padding:16px}
.card{background:var(--card);border:1px solid #ddd;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:20px}
h1{margin:0 0 8px;font-size:24px}
.muted{color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.btn{appearance:none;border:1px solid #ccc;background:#fff;color:#000;padding:12px 16px;border-radius:12px;cursor:pointer;font-size:16px}
.btn.primary{background:linear-gradient(180deg,#2b4bc9,#223c9a);border-color:#2b4bc9;color:#fff}
.btn.ghost{background:transparent}
.btn.small{padding:8px 10px;font-size:14px;border-radius:10px}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.grid{display:grid;gap:12px}
.qbox{padding:18px;border-radius:14px;background:#fff;border:1px solid #ccc}
.hanzi{font-size:40px;letter-spacing:.02em}
.pinyinGuide{font-size:14px;color:var(--muted);margin-top:6px}
.choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:16px}
@media (min-width:560px){.choices{grid-template-columns:1fr 1fr}}
.choice{padding:14px 14px;border-radius:12px;border:1px solid #ccc;background:#f1f3f5;cursor:pointer;text-align:left;font-size:18px}
.choice:hover{outline:2px solid rgba(43,75,201,.35)}
.choice.correct{background:#d7f5e5;border-color:var(--ok)}
.choice.wrong{background:#fddede;border-color:var(--ng)}
.status{margin-top:12px;min-height:24px}
.status.ok{color:var(--ok)}
.status.ng{color:var(--ng)}
.pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f3f5;border:1px solid #ccc;}
.sec{display:flex;gap:8px;flex-wrap:wrap}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
.note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
<div class="card">
<div class="row" style="justify-content:space-between">
<div>
<h1>HSK4級 ピンインクイズ（クリック式）</h1>
<div class="muted">1問ずつ出題。選択肢をクリックして回答できます。音声再生・復習モード付き。</div>
</div>
<div class="row">
<button id="btnReset" class="btn small ghost" title="成績と履歴をすべて削除">進捗リセット</button>
</div>
</div>

<div class="grid" style="margin-top:14px">
<div class="row" style="justify-content:space-between">
<div class="sec">
<button id="btnStart" class="btn primary">クイズ開始（10問）</button>
<button id="btnWrongOnly" class="btn">復習モード：OFF</button>
<button id="btnSay" class="btn ghost">音声を再生</button>
</div>
<div class="pill"><span id="statRate">正答率 0%</span>｜<span id="statTotal">総計 0/0</span></div>
</div>

<div class="qbox">
<div id="qxNum" class="muted">問題 0 / 10</div>
<div class="hanzi" id="qxHanzi">—</div>
<div class="pinyinGuide" id="qxHint">正しいピンインをクリック</div>
<div class="choices" id="choices"></div>
<div id="qxStatus" class="status"></div>
<div class="footer">
<div class="note">クリックで回答（A/B/C/D）。Enterで次へ。</div>
<div class="sec">
<button id="btnNext" class="btn" disabled>次の問題 ▶</button>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// ====== 初期状態・要素参照 ======
const SEED = [ {hanzi:"调查",pinyin:"diàochá"}, {hanzi:"基础",pinyin:"jīchǔ"},
               {hanzi:"考虑",pinyin:"kǎolǜ"}, {hanzi:"工资",pinyin:"gōngzī"} ];
let WORDS = SEED;
const elStart = document.getElementById('btnStart');
const elWrong = document.getElementById('btnWrongOnly');
const elReset = document.getElementById('btnReset');
const elSay   = document.getElementById('btnSay');
const elNext  = document.getElementById('btnNext');
const elChoices = document.getElementById('choices');
const elHanzi   = document.getElementById('qxHanzi');
const elNum     = document.getElementById('qxNum');
const elStatus  = document.getElementById('qxStatus');
const elRate    = document.querySelector('#statRate');
const elTotal   = document.querySelector('#statTotal');

// 起動時は開始ボタンを一旦無効化（JSON読込完了で有効化）
elStart.disabled = true; elStart.textContent = 'データ読込中…';

// ====== JSON自動読込（GitHub Pages対応・キャッシュ回避） ======
(async function loadJson(){
  try{
    const base = new URL('.', location.href);
    const url  = new URL('hsk4.json', base);
    url.searchParams.set('v', Date.now()); // キャッシュ回避
    const r = await fetch(url.toString(), {cache:'no-store'});
    if (!r.ok) throw new Error('HTTP '+r.status);
    const data = await r.json();
    if (Array.isArray(data) && data.length) WORDS = data;
  }catch(e){
    console.warn('hsk4.json 読込失敗。SEEDで起動します:', e);
  }finally{
    elStart.disabled = false;
    elStart.textContent = 'クイズ開始（10問）';
  }
})();

// ====== ピンイン（声調）ユーティリティ ======
const toneMap = {
  a:['a','ā','á','ǎ','à'], e:['e','ē','é','ě','è'], i:['i','ī','í','ǐ','ì'],
  o:['o','ō','ó','ǒ','ò'], u:['u','ū','ú','ǔ','ù'], 'ü':['ü','ǖ','ǘ','ǚ','ǜ']
};
const toneIndexOfChar = (ch) => {
  for (const [k,arr] of Object.entries(toneMap)) {
    const idx = arr.indexOf(ch);
    if (idx > -1) return {base:k, tone:idx}; // 0..4（0=無声調）
  } return null;
};
function splitSyl(py){ return py.trim().split(/\s+/); }
function toneTargetIndex(s){ // 優先規則: a > e > o > i/u/ü
  for (let i=0;i<s.length;i++){ if (toneIndexOfChar(s[i])) return i; }
  for (const v of ['a','e','o','i','u','ü']){ const k=s.indexOf(v); if (k>-1) return k; }
  return -1;
}
function setTone(syl, newTone){ // newTone: 1..4
  const i = toneTargetIndex(syl); if (i<0) return syl;
  const info = toneIndexOfChar(syl[i]) || {base:syl[i], tone:0};
  const base = info.base; const marked = toneMap[base]?.[newTone] || base;
  return syl.slice(0,i) + marked + syl.slice(i+1);
}
function detectTone(syl){ for (const ch of syl){ const t=toneIndexOfChar(ch); if (t) return t.tone; } return 0; }
function shuffle(a){ return a.map(x=>[Math.random(),x]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }

// —— 正解ピンインから「声調違いのダミー」を生成（必ず4択） ——
function genToneOptions(correct){
  const syls = splitSyl(correct);
  const opts = new Set([correct]);
  let guard = 0;
  while (opts.size < 4 && guard < 80){
    guard++;
    // ランダムな音節の声調だけ変える
    const idx = Math.floor(Math.random()*syls.length);
    const s = syls[idx];
    const t = detectTone(s) || 1;
    let newTone = t;
    for (let k=0;k<5 && newTone===t;k++) newTone = 1 + Math.floor(Math.random()*4);
    const cand = syls.map((sy, i)=> i===idx ? setTone(s, newTone) : sy).join(' ');
    opts.add(cand);
  }
  // まだ不足する場合は、別音節も変えて埋める
  while (opts.size < 4){
    const idx = (opts.size % syls.length);
    const cand = syls.map((sy,i)=> i===idx ? setTone(sy, 1 + (i%4)) : sy).join(' ');
    opts.add(cand);
  }
  return shuffle([...opts]);
}

// ====== 進捗（localStorage） ======
const LS = 'hsk4_pinyin_quiz_v1';
let state = (()=>{ try{ return JSON.parse(localStorage.getItem(LS)) || {total:0,correct:0,wrongKeys:{}} }catch(_){ return {total:0,correct:0,wrongKeys:{}} }})();
function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }
function updateStats(){ const acc = state.total? Math.round(100*state.correct/state.total):0;
  elRate.textContent = `正答率 ${acc}%`; elTotal.textContent = `総計 ${state.correct}/${state.total}`; }

// ====== 出題制御 ======
let session = { size:10, idx:0, list:[], wrongOnly:false };
let current = null;

function buildPool(){
  const base = WORDS.slice();
  let pool = session.wrongOnly ? base.filter(w => state.wrongKeys[w.hanzi]) : base;
  if (!pool.length){ // 間違いが無ければ通常出題に戻す
    session.wrongOnly = false;
    elWrong.textContent = '復習モード：OFF';
    pool = base;
  }
  return shuffle(pool).slice(0, session.size);
}
function renderQuestion(){
  if (session.idx >= session.list.length){
    elNum.textContent = '終了';
    elHanzi.textContent = 'おつかれさま！';
    elChoices.innerHTML = ''; elStatus.textContent = ''; elNext.disabled = true; return;
  }
  const word = session.list[session.idx];
  const options = genToneOptions(word.pinyin);
  const correctIndex = options.indexOf(word.pinyin);
  current = {word, options, correctIndex};

  elNum.textContent = `問題 ${session.idx+1} / ${session.list.length}`;
  elHanzi.textContent = word.hanzi;
  elChoices.innerHTML = ''; elStatus.textContent = ''; elNext.disabled = true;

  options.forEach((opt,i)=>{
    const b = document.createElement('button');
    b.className = 'choice'; b.textContent = `${'ABCD'[i]}. ${opt}`;
    b.addEventListener('click', ()=> onAnswer(i));
    elChoices.appendChild(b);
  });
}
function onAnswer(i){
  if (!current) return;
  const ok = (i === current.correctIndex);
  state.total += 1; if (ok) state.correct += 1; else state.wrongKeys[current.word.hanzi]=(state.wrongKeys[current.word.hanzi]||0)+1;
  if (ok && state.wrongKeys[current.word.hanzi]){ state.wrongKeys[current.word.hanzi]-=1; if (state.wrongKeys[current.word.hanzi]<=0) delete state.wrongKeys[current.word.hanzi]; }
  saveState(); updateStats();

  [...elChoices.children].forEach((b,idx)=>{
    b.disabled = true;
    if (idx === current.correctIndex) b.classList.add('correct');
    if (!ok && idx === i) b.classList.add('wrong');
  });

  elStatus.classList.remove('ok','ng');
  if (ok){ elStatus.textContent = `正解！ ${current.word.pinyin}`; elStatus.classList.add('ok'); }
  else   { elStatus.textContent = `不正解… 正解は ${current.word.pinyin}`; elStatus.classList.add('ng'); }
  speak(current.word.hanzi);
  elNext.disabled = false;
}

// ====== 音声（Web Speech API） ======
function speak(text){
  if (!('speechSynthesis' in window)) return; // 非対応ブラウザ
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'zh-CN'; u.rate = 1.0; u.pitch = 1.0;
    // 可能なら中国語ボイスを選択
    const voices = speechSynthesis.getVoices();
    const zh = voices.find(v=>/zh|Chinese/i.test(v.lang||v.name||'')); if (zh) u.voice = zh;
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch(_){}
}

// ====== ハンドラ ======
function startQuiz(){ session.idx=0; session.list = buildPool(); renderQuestion(); }
function nextQ(){ if (session.idx < session.list.length-1){ session.idx++; renderQuestion(); } else { session.idx++; renderQuestion(); } }
function toggleWrong(){ session.wrongOnly = !session.wrongOnly; elWrong.textContent = `復習モード：${session.wrongOnly?'ON':'OFF'}`; startQuiz(); }
function resetAll(){ if(!confirm('全ての進捗（正解数/不正解履歴）を削除します。よろしいですか？')) return;
  state = {total:0,correct:0,wrongKeys:{}}; saveState(); updateStats(); startQuiz(); }

elStart.addEventListener('click', startQuiz);
elNext .addEventListener('click', nextQ);
elWrong.addEventListener('click', toggleWrong);
elReset.addEventListener('click', resetAll);
elSay  .addEventListener('click', ()=>{ if(current) speak(current.word.hanzi); });

// Enterキーで次へ
window.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !elNext.disabled) nextQ(); });

// 初期表示
updateStats();
</script>
</body>
</html>
