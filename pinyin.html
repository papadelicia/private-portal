<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HSK4級 ピンインクイズ（クリック式）</title>
<style>
:root{
--bg:#ffffff; --card:#f8f9fa; --text:#000000; --muted:#555555; --accent:#2b4bc9; --ok:#0a7d42; --ng:#c62828;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Helvetica,Arial,"Noto Sans JP",sans-serif;}
.wrap{max-width:840px;margin:24px auto;padding:16px}
.card{background:var(--card);border:1px solid #ddd;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:20px}
h1{margin:0 0 8px;font-size:24px}
.muted{color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.btn{appearance:none;border:1px solid #ccc;background:#fff;color:#000;padding:12px 16px;border-radius:12px;cursor:pointer;font-size:16px}
.btn.primary{background:linear-gradient(180deg,#2b4bc9,#223c9a);border-color:#2b4bc9;color:#fff}
.btn.ghost{background:transparent}
.btn.small{padding:8px 10px;font-size:14px;border-radius:10px}
.btn[disabled]{opacity:.6;cursor:not-allowed}
.grid{display:grid;gap:12px}
.qbox{padding:18px;border-radius:14px;background:#fff;border:1px solid #ccc}
.hanzi{font-size:40px;letter-spacing:.02em}
.pinyinGuide{font-size:14px;color:var(--muted);margin-top:6px}
.choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:16px}
@media (min-width:560px){.choices{grid-template-columns:1fr 1fr}}
.choice{padding:14px 14px;border-radius:12px;border:1px solid #ccc;background:#f1f3f5;cursor:pointer;text-align:left;font-size:18px}
.choice:hover{outline:2px solid rgba(43,75,201,.35)}
.choice.correct{background:#d7f5e5;border-color:var(--ok)}
.choice.wrong{background:#fddede;border-color:var(--ng)}
.status{margin-top:12px;min-height:24px}
.status.ok{color:var(--ok)}
.status.ng{color:var(--ng)}
.pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f3f5;border:1px solid #ccc;}
.sec{display:flex;gap:8px;flex-wrap:wrap}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px}
.note{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
<div class="card">
<div class="row" style="justify-content:space-between">
<div>
<h1>HSK4級 ピンインクイズ（クリック式）</h1>
<div class="muted">1問ずつ出題。選択肢をクリックして回答できます。音声再生・復習モード付き。</div>
</div>
<div class="row">
<button id="btnReset" class="btn small ghost" title="成績と履歴をすべて削除">進捗リセット</button>
</div>
</div>

<div class="grid" style="margin-top:14px">
<div class="row" style="justify-content:space-between">
<div class="sec">
<button id="btnStart" class="btn primary">クイズ開始（10問）</button>
<button id="btnWrongOnly" class="btn">復習モード：OFF</button>
<button id="btnSay" class="btn ghost">音声を再生</button>
</div>
<div class="pill"><span id="statRate">正答率 0%</span>｜<span id="statTotal">総計 0/0</span></div>
</div>

<div class="qbox">
<div id="qxNum" class="muted">問題 0 / 10</div>
<div class="hanzi" id="qxHanzi">—</div>
<div class="pinyinGuide" id="qxHint">正しいピンインをクリック</div>
<div class="choices" id="choices"></div>
<div id="qxStatus" class="status"></div>
<div class="footer">
<div class="note">クリックで回答（A/B/C/D）。Enterで次へ。</div>
<div class="sec">
<button id="btnNext" class="btn" disabled>次の問題 ▶</button>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
// ====== 状態管理 ======
let words = [];
let state = JSON.parse(localStorage.getItem('quizState')||'{"total":0,"correct":0,"wrongKeys":{}}');
let session = {idx:0,list:[],wrongOnly:false};
let current=null;

// 要素取得
const elStart=document.getElementById('btnStart');
const elWrong=document.getElementById('btnWrongOnly');
const elReset=document.getElementById('btnReset');
const elSay=document.getElementById('btnSay');
const elNext=document.getElementById('btnNext');
const elChoices=document.getElementById('choices');
const elHanzi=document.getElementById('qxHanzi');
const elNum=document.getElementById('qxNum');
const elStatus=document.getElementById('qxStatus');
const elRate=document.getElementById('statRate');
const elTotal=document.getElementById('statTotal');

function saveState(s){ localStorage.setItem('quizState',JSON.stringify(s)); }
function updateStatsUI(){
  elRate.textContent=`正答率 ${state.total?Math.round(state.correct/state.total*100):0}%`;
  elTotal.textContent=`総計 ${state.total}/${state.total}`;
}

// ====== JSONロード ======
fetch('hsk4.json?nocache='+Date.now())
.then(r=>r.json())
.then(data=>{
  words=data;
  console.log("Loaded", words.length);
})
.catch(e=>{
  console.error("JSON読み込みエラー", e);
});

// ====== 出題 ======
function buildPool(){
  let pool=words.slice();
  if(session.wrongOnly){
    pool=pool.filter(w=>state.wrongKeys[w.hanzi]);
  }
  pool=shuffle(pool).slice(0,10);
  return pool.map(w=>{
    let options=[w.pinyin];
    while(options.length<4){
      let c=words[Math.floor(Math.random()*words.length)].pinyin;
      if(!options.includes(c)) options.push(c);
    }
    options=shuffle(options);
    return {word:w,options,correctIndex:options.indexOf(w.pinyin)};
  });
}
function shuffle(a){return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);}
function renderQuestion(){
  if(session.idx>=session.list.length){elHanzi.textContent="終了！";elChoices.innerHTML="";elNext.disabled=true;return;}
  current=session.list[session.idx];
  elNum.textContent=`問題 ${session.idx+1} / ${session.list.length}`;
  elHanzi.textContent=current.word.hanzi;
  elChoices.innerHTML='';
  current.options.forEach((opt,i)=>{
    const btn=document.createElement('button');
    btn.className='choice';
    btn.textContent=`${'ABCD'[i]}. ${opt}`;
    btn.addEventListener('click',()=>onAnswer(i,btn));
    elChoices.appendChild(btn);
  });
  elStatus.textContent='';
  elNext.disabled=true;
}
function onAnswer(i,btn){
  if(!current) return;
  const ok=(i===current.correctIndex);
  state.total+=1;
  if(ok) state.correct+=1;
  saveState(state);
  updateStatsUI();
  [...elChoices.children].forEach((b,idx)=>{
    b.disabled=true;
    if(idx===current.correctIndex) b.classList.add('correct');
    if(!ok&&idx===i) b.classList.add('wrong');
  });
  if(!ok){ state.wrongKeys[current.word.hanzi]=(state.wrongKeys[current.word.hanzi]||0)+1; saveState(state);}
  else { if(state.wrongKeys[current.word.hanzi]){ state.wrongKeys[current.word.hanzi]-=1;if(state.wrongKeys[current.word.hanzi]<=0) delete state.wrongKeys[current.word.hanzi]; saveState(state);} }
  elStatus.classList.remove('ok','ng');
  if(ok){elStatus.textContent=`正解！ ${current.word.pinyin}`;elStatus.classList.add('ok');}
  else {elStatus.textContent=`不正解… 正解は ${current.word.pinyin}`;elStatus.classList.add('ng');}
  elNext.disabled=false;
}

// ====== ハンドラ ======
function startQuiz(){session.idx=0;session.list=buildPool();renderQuestion();}
function nextQuestion(){if(session.idx<session.list.length-1){session.idx++;renderQuestion();}else{session.idx++;renderQuestion();}}
function toggleWrong(){session.wrongOnly=!session.wrongOnly;elWrong.textContent=`復習モード：${session.wrongOnly?'ON':'OFF'}`;startQuiz();}
function resetAll(){if(!confirm('全ての進捗を削除します。よろしいですか？'))return;state={total:0,correct:0,wrongKeys:{}};saveState(state);updateStatsUI();startQuiz();}

elStart.addEventListener('click',startQuiz);
elNext.addEventListener('click',nextQuestion);
elWrong.addEventListener('click',toggleWrong);
elReset.addEventListener('click',resetAll);
elSay.addEventListener('click',()=>{if(current) alert(current.word.hanzi);}); // 仮音声

window.addEventListener('keydown',e=>{if(e.key==='Enter'&&!elNext.disabled) nextQuestion();});

updateStatsUI();
</script>
</body>
</html>
